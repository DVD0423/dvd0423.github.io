<!DOCTYPE html><html lang="null"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>KVM源码笔记 | Hexo</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/3.0.3/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">KVM源码笔记</h1><a id="logo" href="/.">Hexo</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">KVM源码笔记</h1><div class="post-meta">Mar 25, 2016<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2016/03/25/markdownFile/" href="/2016/03/25/markdownFile/#comments" class="ds-thread-count"></a><div class="post-content"><p>所有hypercall介绍：Documentation/virtual/kvm/hypercalls.txt</p>
<p>/<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><em>**</em></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong> <strong>华丽丽的分割线<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>/</p>
<p>经典的虚拟化使用了陷入-模拟的模式，而硬件辅助虚拟化引入了根模式（root operation）和非根模式（none-root operation），每种模式都有ring0-3<br>的四级特权级别。所以，在硬件辅助虚拟化中，陷入的概念实际上被VM-EXIT操作取代了，它代表从非根模式退出到根模式，而从根模式切换到非根模式是VM-Entry操作。</p>
<h3 id="KVM处理器虚拟化——VMCS结构"><a href="#KVM处理器虚拟化——VMCS结构" class="headerlink" title="KVM处理器虚拟化——VMCS结构"></a>KVM处理器虚拟化——VMCS结构</h3><p>X86处理器一共有4级特权环（Ring）。linux系统只用了Ring0和Ring3，Ring0用来运行操作系统，Ring3用来作为应用程序特权级别。在KVM虚拟化系统中，VMM位于Ring0。 VT-x将处理器操作模式分为两种，<br>根虚拟化操作模式和非根虚拟化操作模式。这使得虚拟机操作系统的特权指令直接运行在硬件上，从而消除的虚拟机操作系统执行特权指令时”动态指令重写”过程。虚拟机执行一些访问全局资源的指令时，将导致<br>VMExit，从而使VMM获得控制权。主机和虚拟机的处理器状态及参数都被保存在一段专用的地址空间，处理器根虚拟化模式和非根虚拟化模式切换完全由硬件实现。使指令重写速度更快，处理过程的完整性也得到保障，<br>也使不同虚拟机操作系统处于更好的隔离状态，提高安全性。</p>
<h3 id="KVM内存虚拟化——影子页表"><a href="#KVM内存虚拟化——影子页表" class="headerlink" title="KVM内存虚拟化——影子页表"></a>KVM内存虚拟化——影子页表</h3><p>VTLB虚拟TLB<br>EPT(扩展页表)技术实质上是将影子页表的算法用硬件来实现。EPT由处理器直接执行，提高了vmm的虚拟化效率，降低了内存管理的复杂度。影子页表是根据虚拟机页表建立的。VMM负责影子页表的建立和维护。<br>随着虚拟机页表的变化而更新;<br>MMU(内存管理单元)技术从硬件上实现了虚拟机操作系统内部地址到虚拟机物理地址的转换，但是并没有实现虚拟机物理地址到主机物理地址的转换。<br>虚拟机缺页会引发VMExit处理。虚拟街缺页有两种：一种是和实际机器一样的缺页，kvm将直接注入一个缺页异常由虚拟机根据自身页表查询处理。另一种缺页异常是由于虚拟机页表和影子页表不一致造成的，<br>kvm按照虚拟机页表进行客户机物理地址到主机物理地址的转换并更新影子页表，完成后执行VMEntry返回用户空间重新执行这个缺页异常指令。<br>影子页表的实现需要两次内存转换，为了提速引入TLB(旁路转换缓存)。当处理器收到影子页表查询指令时，将首先查询TLB。</p>
<h3 id="KVM-I-O虚拟化"><a href="#KVM-I-O虚拟化" class="headerlink" title="KVM I/O虚拟化"></a>KVM I/O虚拟化</h3><p>虚拟机进行I/O操作时通过操作系统的设备驱动程序发出申请，kvm捕获到该申请后将I/O操作相关的信息如端口号等数据信息保存在”I/O共享页”。Qemu模拟程序接受到模拟指令后，通过读取I/O共享页获取操作参数，<br>判断该操作是由模拟完成还是通过触发真实的硬件I/O，完成I/O模拟或操作后将操作结果信息写回I/O共享页。Qemu写入完成后向kvm模块的捕获程序发出信号，捕获程序将I/O结果数据读出注入发出I/O申请的虚拟机<br>并执行VMEntry使虚拟机进入客户模式继续执行。<br>“泛虚拟化Virtio”<br>通过为虚拟机操作系统安装前端驱动，使针对特定设备的访问不通过该设备的驱动，而是通过virtio的前端驱动来提出申请，前端驱动直接与后端驱动进行交互。后端驱动实现了该设备的模拟，还允许KVM导出一组通用<br>虚拟设备。与kvm本身的设备模拟使用I/O共享页不同，virtio使用队列进行数据交互，能够保存前端驱动的多个I/O请求，从而使后端驱动可以批量处理。virtio不需要qemu针对硬件进行I/O模拟，避免了Qemu模拟<br>真实硬件时形成的内核空间和用户空间反复切换过程。但是泛虚拟化必须针对不同的系统或不同的需求设计开发不同的前端驱动，虚拟机操作系统必须安装这些前端驱动才能使用。</p>
<p>/<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><em>**</em></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong> <strong>华丽丽的分割线<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>/</p>
<h3 id="Qemu"><a href="#Qemu" class="headerlink" title="Qemu"></a>Qemu</h3><p>下文是针对KVM模式下的Qemu调度流程，如果是自身的TCG模式，执行不同的操作。<br>kvm_cpu_exec函数是qemu与kvm的接口</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span>&#123;	<span class="comment">//vl.c——主要进行初始化设置，eg：创建多少vcpu，是否开启NUMA，分配多少虚拟内存资源等等</span></span><br><span class="line">	|</span><br><span class="line">	|——<span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">configure_accelerator</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">	|<span class="comment">/* 决定了使用何种虚拟化解决方案，kvm为第三种,accel_list[2]=&#123;"kvm", "KVM", kvm_available, kvm_init, &amp;kvm_allowed &#125;,</span><br><span class="line">	|kvm_init指向了kvm_all.c中的kvm_init()函数*/</span></span><br><span class="line">	|	|</span><br><span class="line">	|	|——kvm_init()</span><br><span class="line">	|			|</span><br><span class="line">	|			|——s-&gt;fd = qemu_open(<span class="string">"/dev/kvm"</span>, O_RDWR);</span><br><span class="line">	|			|</span><br><span class="line">	|			|——Int ret = kvm_ioctl(s, KVM_GET_API_VERSION, <span class="number">0</span>);</span><br><span class="line">	|			|</span><br><span class="line">	|			|——s-&gt;vmfd = kvm_ioctl(s, KVM_CREATE_VM, <span class="number">0</span>);</span><br><span class="line">	|			|<span class="comment">//对应virt/kvm/kvm_main.c中的kvm_dev_ioctl(...) 创建一个虚拟机，返回一个fd，通过这个fd操作虚拟机</span></span><br><span class="line">	|			|——ret = kvm_arch_init(s);</span><br><span class="line">	|			|</span><br><span class="line">	|			|——ret = kvm_irqchip_create(s);</span><br><span class="line">	|			|</span><br><span class="line">	|			|——memory_listener_register(&amp;kvm_memory_listener, <span class="literal">NULL</span>);<span class="comment">//</span></span><br><span class="line">	|</span><br><span class="line">	|——qemu_init_main_loop();	<span class="comment">//</span></span><br><span class="line">	|	|——main_loop_wait()</span><br><span class="line">	|</span><br><span class="line">	|——cpu_exec_init_all();		<span class="comment">//exec.c</span></span><br><span class="line">	|	|</span><br><span class="line">	|	|——memory_map_init();	<span class="comment">//exec.c</span></span><br><span class="line">	|		|</span><br><span class="line">	|		|——set_system_memory_map()和set_system_io_map()	<span class="comment">//memory.c</span></span><br><span class="line">	|		|	|</span><br><span class="line">	|			|——memory_region_update_topology()</span><br><span class="line">	|				|</span><br><span class="line">	|				|——address_space_update_topology()</span><br><span class="line">	|				|...</span><br><span class="line">	|		|</span><br><span class="line">	|		|——memory_listener_register(io)和memory_listener_register(mem)	<span class="comment">//memory.c</span></span><br><span class="line">	|</span><br><span class="line">	|	|</span><br><span class="line">	|	|——io_mem_init()</span><br><span class="line">	|		|</span><br><span class="line">	|		|——memory_region_init_io()</span><br><span class="line">	|		</span><br><span class="line">	|</span><br><span class="line">	|——machine-&gt;init();	<span class="comment">//为客户系统创建虚拟的CPU、内存、I/O资源等。</span></span><br><span class="line">	|<span class="comment">/*static QEMUMachine pc_machine = &#123;</span><br><span class="line">    |	.name = "pc-0.14",</span><br><span class="line">    |	.alias = "pc",</span><br><span class="line">    |	.desc = "Standard PC",</span><br><span class="line">    |	.init = pc_init_pci,——————————————————————pc_init_pci()在/hw/pc_piix.c中</span><br><span class="line">    |	.max_cpus = 255,</span><br><span class="line">    |	.is_default = 1,</span><br><span class="line">	|&#125;;*/</span></span><br><span class="line">	|	|——pc_init1()	<span class="comment">//qemu/hw/pc_piix.c————硬件设备初始化模块</span></span><br><span class="line">	|		|</span><br><span class="line">	|		|——pc_cpus_init(<span class="keyword">const</span> <span class="keyword">char</span> *cpu_model)<span class="comment">//qemu/hw/pc.c</span></span><br><span class="line">	|		|</span><br><span class="line">	|		|——pc_new_cpu(cpu_model)</span><br><span class="line">	|			|</span><br><span class="line">	|			|——cpu_x86_init(cpu_model)	<span class="comment">//target-i386/helper.c</span></span><br><span class="line">	|			|	|</span><br><span class="line">	|				|——x86_cpu_realize()</span><br><span class="line">	|					|</span><br><span class="line">	|					|——qemu_init_vcpu()</span><br><span class="line">	|						|</span><br><span class="line">	|						|——qemu_kvm_start_vcpu()			<span class="comment">//cpus.c	为每个vcpu创建线程</span></span><br><span class="line">	|							|</span><br><span class="line">	|							|——qemu_kvm_cpu_thread_fn()</span><br><span class="line">	|								|</span><br><span class="line">	|								|——kvm_init_vcpu()</span><br><span class="line">	|									|</span><br><span class="line">	|									|——kvm_ioctl()/kvm_vm_ioctl()...</span><br><span class="line">	|										|</span><br><span class="line">	|										|——ioctl()		<span class="comment">//系统调用，转到核心态，由kvm执行vcpu创建,</span></span><br><span class="line">	|								|<span class="comment">/*while (1) &#123;</span><br><span class="line">	|								|		if (cpu_can_run(env)) &#123;</span><br><span class="line">	|								|			r = kvm_cpu_exec(env);</span><br><span class="line">	|								|			if (r == EXCP_DEBUG) &#123;</span><br><span class="line">	|								|				cpu_handle_guest_debug(env);</span><br><span class="line">	|								|			&#125;</span><br><span class="line">	|								|		&#125;</span><br><span class="line">	|								|		qemu_kvm_wait_io_event(env);</span><br><span class="line">	|								|&#125;*/</span></span><br><span class="line">	|								|——cpu_can_run()<span class="comment">//判断</span></span><br><span class="line">	|								|</span><br><span class="line">	|								|——kvm_cpu_exec()		<span class="comment">//kvm_all.c	主要的东西</span></span><br><span class="line">    |                               |   <span class="keyword">while</span>(ret != <span class="number">0</span>)</span><br><span class="line">	|									    |——ret = kvm_vcpu_ioctl(env, KVM_RUN, <span class="number">0</span>);	<span class="comment">//重要</span></span><br><span class="line">	|									    |——<span class="keyword">switch</span> (run-&gt;exit_reason) <span class="comment">//根据退出原因选择处理方式,改变ret****************************************qemu与kvm的接口</span></span><br><span class="line">        </span><br><span class="line">	|		|							</span><br><span class="line">	|		|——pc_memory_init();	<span class="comment">//qemu/hw/pc.c</span></span><br><span class="line">	|		|</span><br><span class="line">	|		|——pc_basic_device_init()</span><br><span class="line">	|		|</span><br><span class="line">	|		|——pc_pci_device_init()</span><br><span class="line">	|		|——pc_isa_device_init()</span><br><span class="line">	|		|——pc_cmos_init()</span><br><span class="line">	|		|——...</span><br><span class="line">	|</span><br><span class="line">	|——main_loop()	<span class="comment">//vl.c		？？？？</span></span><br><span class="line">	|<span class="comment">/*检测vm的各种状态，eg：qemu_shutdown_requested(),然后做出相应处理</span><br><span class="line">	|</span><br><span class="line">	|*/</span></span><br><span class="line">```	</span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************ **华丽丽的分割线************************************************************************/</span></span><br><span class="line"><span class="meta">### KVM--kvm_main.c</span></span><br><span class="line">```<span class="function">cpp</span><br><span class="line"></span><br><span class="line"><span class="title">module_init</span><span class="params">(vmx_init)</span></span>; <span class="comment">//vmx.c</span></span><br><span class="line">	|</span><br><span class="line">	|—— kvm_init( &amp;vmx_x86_ops, <span class="keyword">sizeof</span>(struct vcpu_vmx), __alignof__(struc vcpu_vmx), THIS_MODULE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kvm_init</span><span class="params">(<span class="keyword">void</span> *opaque, <span class="keyword">unsigned</span> vcpu_size, <span class="keyword">unsigned</span> vcpu_align, <span class="keyword">struct</span> module *module)</span></span>;</span><br><span class="line"><span class="comment">//struct kvm_x86_ops *ops = (struct kvm_x86_ops *)opaque;--vmx_x86_ops</span></span><br><span class="line">	|——	<span class="function"><span class="keyword">int</span> <span class="title">kvm_arch_init</span><span class="params">(<span class="keyword">void</span> *opaque)</span></span>;</span><br><span class="line">	|	|</span><br><span class="line">	|	|——<span class="function"><span class="keyword">int</span> <span class="title">kvm_mmu_module_init</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">	|</span><br><span class="line">	|——	<span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">kvm_irqfd_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;return <span class="number">0</span>;&#125;</span><br><span class="line">	|</span><br><span class="line">	|——	<span class="function"><span class="keyword">int</span> <span class="title">kvm_arch_hardware_setup</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">	|</span><br><span class="line">	|——	kvm_chardev_ops;	<span class="comment">//硬件</span></span><br><span class="line">	|	|</span><br><span class="line">	|	|——<span class="keyword">static</span> <span class="keyword">struct</span> file_operations kvm_chardev_ops = &#123;</span><br><span class="line">	|			.unlocked_ioctl = kvm_dev_ioctl,		<span class="comment">//******************对应kvm_dev_ioctl函数——————11111111</span></span><br><span class="line">	|			.compat_ioctl   = kvm_dev_ioctl,</span><br><span class="line">	|			.llseek		= noop_llseek,</span><br><span class="line">	|		&#125;;</span><br><span class="line">	|</span><br><span class="line">	|——	kvm_vm_fops;		<span class="comment">//虚拟机</span></span><br><span class="line">	|	|</span><br><span class="line">	|	|——<span class="keyword">static</span> <span class="keyword">struct</span> file_operations kvm_vm_fops = &#123;</span><br><span class="line">	|			.release        = kvm_vm_release,</span><br><span class="line">	|			.unlocked_ioctl = kvm_vm_ioctl,		<span class="comment">//*************** kvm_vm_ioctl 222222222222222222222</span></span><br><span class="line">	|			...</span><br><span class="line">	|		&#125;;</span><br><span class="line">	|</span><br><span class="line">	|——	kvm_vcpu_fops;		<span class="comment">//虚拟cpu</span></span><br><span class="line">	|	|</span><br><span class="line">	|	|——<span class="keyword">static</span> <span class="keyword">struct</span> file_operations kvm_vcpu_fops = &#123;</span><br><span class="line">	|			.release        = kvm_vcpu_release,</span><br><span class="line">	|			.unlocked_ioctl = kvm_vcpu_ioctl,	<span class="comment">//***************kvm_vcpu_ioctl 333333333333333333</span></span><br><span class="line">	|			...</span><br><span class="line">	|		&#125;;</span><br><span class="line">	|</span><br><span class="line">	|——	misc_register(&amp;kvm_dev);<span class="comment">//int misc_register(struct miscdevice * misc);</span></span><br><span class="line">	|</span><br><span class="line">	|——	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">kvm_sched_in</span><span class="params">(<span class="keyword">struct</span> preempt_notifier *pn, <span class="keyword">int</span> cpu)</span></span>;				<span class="comment">//vcpu调度</span></span><br><span class="line">	|	|</span><br><span class="line">	|	|——<span class="function"><span class="keyword">void</span> <span class="title">kvm_arch_vcpu_load</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu, <span class="keyword">int</span> cpu)</span></span>;</span><br><span class="line">	|		|</span><br><span class="line">	|		|——	kvm_x86_ops-&gt;vcpu_load(vcpu, cpu);</span><br><span class="line">	|</span><br><span class="line">	|——	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">kvm_sched_out</span><span class="params">(<span class="keyword">struct</span> preempt_notifier *pn, <span class="keyword">struct</span> task_struct *next)</span></span>;</span><br><span class="line">	|	|</span><br><span class="line">	|	|——<span class="function"><span class="keyword">void</span> <span class="title">kvm_arch_vcpu_put</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu)</span></span>;</span><br><span class="line">	|</span><br><span class="line"></span><br><span class="line"><span class="comment">/*****************************************************kvm_dev_ioctl****************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">kvm_dev_ioctl</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> ioctl, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span>;</span><br><span class="line">	|</span><br><span class="line">    |——	<span class="keyword">switch</span>(ioctl)</span><br><span class="line">    |</span><br><span class="line">    |——	<span class="keyword">case</span> KVM_CREATE_VM:</span><br><span class="line">    |	|</span><br><span class="line">	|	|——	<span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">kvm_dev_ioctl_create_vm</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> type)</span></span>;</span><br><span class="line">	|	|</span><br><span class="line">	|		|—— <span class="function"><span class="keyword">static</span> <span class="keyword">struct</span> kvm *<span class="title">kvm_create_vm</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> type)</span></span>;</span><br><span class="line">    |    		|</span><br><span class="line">    |        	|——	<span class="function"><span class="keyword">struct</span> kvm *<span class="title">kvm_arch_alloc_vm</span><span class="params">(<span class="keyword">void</span>)</span></span>;    <span class="comment">//分配kvm内存，kvm = (struct kvm *)(vm_base + offsetof(struct kvm_vm_data, kvm_vm_struct));</span></span><br><span class="line">    |        	|</span><br><span class="line">    |        	|——	<span class="function"><span class="keyword">int</span> <span class="title">kvm_arch_init_vm</span><span class="params">(<span class="keyword">struct</span> kvm *kvm, <span class="keyword">unsigned</span> <span class="keyword">long</span> type)</span></span>;  <span class="comment">//初始化kvm数据结构</span></span><br><span class="line">    |       |</span><br><span class="line">    |       |—— <span class="function"><span class="keyword">int</span> <span class="title">anon_inode_getfd</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">struct</span> file_operations *fops, <span class="keyword">void</span> *priv, <span class="keyword">int</span> flags)</span></span>;</span><br><span class="line">    |        	<span class="comment">//anon_inode_getfd("kvm-vm", &amp;kvm_vm_fops, kvm, O_RDWR);返回文件描述符</span></span><br><span class="line">    |        	|——<span class="keyword">static</span> <span class="keyword">struct</span> file_operations kvm_vm_fops = &#123;</span><br><span class="line">    |			|		.release        = kvm_vm_release,</span><br><span class="line">	|			|		.unlocked_ioctl = kvm_vm_ioctl,			<span class="comment">//***************222222222222222222222</span></span><br><span class="line">    |			|		...</span><br><span class="line">    |			|	&#125;;</span><br><span class="line">    |</span><br><span class="line">    |—— <span class="keyword">case</span> KVM_GET_VCPU_MMAP_SIZE:</span><br><span class="line">    |	|——	r= PAGE_SIZE;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*************************************************** **kvm_vm_ioctl****************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">kvm_vm_ioctl</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> ioctl, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span>;</span><br><span class="line">    |   <span class="keyword">switch</span>(ioctl)</span><br><span class="line">    |</span><br><span class="line">    |—— <span class="keyword">case</span> KVM_CREATE_VCPU:</span><br><span class="line">	|	 |</span><br><span class="line">	|	 |—— <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">kvm_vm_ioctl_create_vcpu</span><span class="params">(<span class="keyword">struct</span> kvm *kvm, u32 id)</span></span>;</span><br><span class="line">	|		|</span><br><span class="line">	|		|—— <span class="function"><span class="keyword">struct</span> kvm_vcpu *<span class="title">kvm_arch_vcpu_create</span><span class="params">(<span class="keyword">struct</span> kvm *kvm, <span class="keyword">unsigned</span> <span class="keyword">int</span> id)</span></span>;		<span class="comment">//分配空间</span></span><br><span class="line">	|			|</span><br><span class="line">	|			|——kvm_x86_ops-&gt;vcpu_create(kvm, id);<span class="comment">//---vmx_create_vcpu</span></span><br><span class="line">	|		|</span><br><span class="line">	|		|——	<span class="function"><span class="keyword">int</span> <span class="title">kvm_arch_vcpu_setup</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu)</span></span>;		<span class="comment">//设置vcpu参数</span></span><br><span class="line">	|			|</span><br><span class="line">	|			|——	<span class="function"><span class="keyword">int</span> <span class="title">vcpu_load</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu)</span></span>;		<span class="comment">//vcpu-&gt;pid = get_task_pid(...)</span></span><br><span class="line">	|			|</span><br><span class="line">	|			|—— kvm_vcpu_reset();kvm_mmu_setup();</span><br><span class="line">	|		|<span class="comment">/* Now it's all set up, let userspace reach it */</span></span><br><span class="line">	|		|——	<span class="function"><span class="keyword">void</span> <span class="title">kvm_get_kvm</span><span class="params">(<span class="keyword">struct</span> kvm *kvm)</span></span>;	<span class="comment">//kvm-&gt;users_count加一</span></span><br><span class="line">	|		|</span><br><span class="line">	|		|—— <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">create_vcpu_fd</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu)</span></span>;		<span class="comment">//vcpu的文件描述符</span></span><br><span class="line">	|			|</span><br><span class="line">	|			|—— anon_inode_getfd(<span class="string">"kvm-vcpu"</span>, &amp;kvm_vcpu_fops, vcpu, O_RDWR);<span class="comment">//通过kvm_vcpu_fops结构体与其它函数联系</span></span><br><span class="line">	|				|——	<span class="keyword">static</span> <span class="keyword">struct</span> file_operations kvm_vcpu_fops = &#123;</span><br><span class="line">	|				|		.release        = kvm_vcpu_release,</span><br><span class="line">	|				|		.unlocked_ioctl = kvm_vcpu_ioctl,			<span class="comment">//***************3333333333333333333</span></span><br><span class="line">	|				|		...</span><br><span class="line">	|				|	&#125;;</span><br><span class="line">	|</span><br><span class="line">    |—— <span class="keyword">case</span> KVM_SET_USER_MEMORY_REGION:</span><br><span class="line">    |	|</span><br><span class="line">    |   |——	<span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">copy_from_user</span><span class="params">(<span class="keyword">void</span> *to, <span class="keyword">const</span> <span class="keyword">void</span> __user *from, <span class="keyword">unsigned</span> <span class="keyword">long</span> n)</span></span>;<span class="comment">//copy_from_user——copy_to_user</span></span><br><span class="line">    |	|</span><br><span class="line">    |   |—— <span class="function"><span class="keyword">int</span> <span class="title">kvm_vm_ioctl_set_memory_region</span><span class="params">(<span class="keyword">struct</span> kvm *kvm, <span class="keyword">struct</span> kvm_userspace_memory_region *mem)</span></span>;</span><br><span class="line">    |		|</span><br><span class="line">    |    	|—— <span class="function"><span class="keyword">int</span> <span class="title">kvm_set_memory_region</span><span class="params">(<span class="keyword">struct</span> kvm *kvm, <span class="keyword">struct</span> kvm_userspace_memory_region *mem)</span></span>;</span><br><span class="line">    |			|</span><br><span class="line">    |           |——	<span class="keyword">int</span> __kvm_set_memory_region(<span class="keyword">struct</span> kvm *kvm, <span class="keyword">struct</span> kvm_userspace_memory_region *mem);<span class="comment">//************************拷贝用户空间内存</span></span><br><span class="line">    |</span><br><span class="line">    |—— <span class="keyword">case</span> KVM_CREATE_DEVICE:</span><br><span class="line">    |	|</span><br><span class="line">    |   |—— <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">kvm_ioctl_create_device</span><span class="params">(<span class="keyword">struct</span> kvm *kvm, <span class="keyword">struct</span> kvm_create_device *cd)</span></span>;</span><br><span class="line">    |		|</span><br><span class="line">    |    	|——	anon_inode_getfd(ops-&gt;name, &amp;kvm_device_fops, dev, O_RDWR);</span><br><span class="line">    |    		|</span><br><span class="line">	|			|——	<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct</span> file_operations kvm_device_fops = &#123;</span><br><span class="line">    |    		|		.unlocked_ioctl = kvm_device_ioctl,<span class="comment">//static long kvm_device_ioctl(struct file *filp, unsigned int ioctl, unsigned long arg)</span></span><br><span class="line">        		|	#ifdef CONFIG_COMPAT</span><br><span class="line">	|			|		.compat_ioctl = kvm_device_ioctl,</span><br><span class="line">        		|	#endif</span><br><span class="line">	|			|		.release = kvm_device_release,<span class="comment">//kvm_put_kvm</span></span><br><span class="line">    |   		|	&#125;;</span><br><span class="line">    </span><br><span class="line"><span class="comment">/*************************************************** **kvm_vm_ioctl****************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">kvm_vcpu_ioctl</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> ioctl, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span>;</span><br><span class="line">    |</span><br><span class="line">    |——	<span class="function"><span class="keyword">int</span> <span class="title">vcpu_load</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu)</span></span>;			<span class="comment">//找到匹配的cpu初始化vcpu，然后vcpu_put()</span></span><br><span class="line">    |	|</span><br><span class="line">	|	|—— cpu = get_cpu();	<span class="comment">//返回当前处理器的id号</span></span><br><span class="line">    |	|</span><br><span class="line">	|	|—— <span class="function"><span class="keyword">void</span> <span class="title">kvm_arch_vcpu_load</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu, <span class="keyword">int</span> cpu)</span></span>;</span><br><span class="line">    |		|</span><br><span class="line">	|		|—— kvm_x86_ops-&gt;vcpu_load(vcpu, cpu);										<span class="comment">//具体x86架构实现是vmx_x86_ops-&gt;vcpu_load(...)</span></span><br><span class="line">    |</span><br><span class="line">	|—— <span class="keyword">switch</span>(ioctl)</span><br><span class="line">	|</span><br><span class="line">	|—— <span class="keyword">case</span> KVM_RUN:</span><br><span class="line">	|	|</span><br><span class="line">    |	|—— <span class="function"><span class="keyword">int</span> <span class="title">kvm_arch_vcpu_ioctl_run</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu, <span class="keyword">struct</span> kvm_run *kvm_run)</span></span>;</span><br><span class="line">	|		|</span><br><span class="line">    |		|——<span class="keyword">static</span> <span class="keyword">int</span> __vcpu_run(<span class="keyword">struct</span> kvm_vcpu *vcpu);</span><br><span class="line">	|			|</span><br><span class="line">	|			|—— <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	|				|</span><br><span class="line">	|				|—— <span class="keyword">if</span>(...) ();</span><br><span class="line">	|					|</span><br><span class="line">	|					|—— <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">kvm_check_request</span><span class="params">(<span class="keyword">int</span> req, <span class="keyword">struct</span> kvm_vcpu *vcpu)</span></span>;<span class="comment">//检查各种请求，作出处理</span></span><br><span class="line">	|					|</span><br><span class="line">	|					|—— inject_pending_event(vcpu);		<span class="comment">//调用vmx的相关操作</span></span><br><span class="line">	|					|</span><br><span class="line">	|					|—— <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">kvm_mmu_reload</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu)</span></span>;<span class="comment">//调用kvm_mmu_load();</span></span><br><span class="line">	|					|</span><br><span class="line">	|					|—— <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">kvm_load_guest_xcr0</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu)</span></span>;</span><br><span class="line">	|					|</span><br><span class="line">	|					|—— vcpu-&gt;mode = IN_GUEST_MODE;</span><br><span class="line">	|					|</span><br><span class="line">	|					|—— <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">kvm_guest_enter</span><span class="params">(<span class="keyword">void</span>)</span></span>;	<span class="comment">//改变current标识</span></span><br><span class="line">	|					|</span><br><span class="line">	|					|—— kvm_x86_ops-&gt;run(vcpu);					<span class="comment">//****************主要</span></span><br><span class="line">	|					|</span><br><span class="line">	|					|—— kvm_guest_exit();</span><br><span class="line">	|					|</span><br><span class="line">	|					|—— kvm_x86_ops-&gt;handle_exit(vcpu);			<span class="comment">//****************主要</span></span><br><span class="line">	|				|</span><br><span class="line">	|				|—— <span class="keyword">else</span></span><br><span class="line">	|					|</span><br><span class="line">	|					|—— <span class="keyword">void</span> kvm_vcpu_block(struct kvm_vcpu *vcpu);</span><br><span class="line">	|						|</span><br><span class="line">	|						|—— asmlinkage <span class="keyword">void</span> __<span class="function">sched <span class="title">schedule</span><span class="params">(<span class="keyword">void</span>)</span></span>;		<span class="comment">//在进入guest之前调度cpu</span></span><br><span class="line">	|</span><br><span class="line">	|—— <span class="keyword">case</span> KVM_GET_REGS:</span><br><span class="line">	|—— <span class="keyword">case</span> KVM_SET_REGS:</span><br><span class="line">	|—— <span class="keyword">case</span> KVM_GET_SREGS:</span><br><span class="line">	|—— <span class="keyword">case</span> KVM_SET_SREGS:</span><br><span class="line">	|—— <span class="keyword">case</span> KVM_GET_MP_STATE:</span><br><span class="line">	|—— <span class="keyword">case</span> KVM_SET_MP_STATE:</span><br><span class="line">	|—— <span class="keyword">case</span> KVM_TRANSLATE:</span><br><span class="line">	|—— <span class="keyword">case</span> KVM_SET_SIGNAL_MASK:</span><br><span class="line">	|-- <span class="keyword">case</span> KVM_SET_GUEST_DEBUG:</span><br><span class="line">	|—— <span class="keyword">case</span> KVM_GET_FPU:</span><br><span class="line">	|—— <span class="keyword">case</span> KVM_SET_FPU:</span><br></pre></td></tr></table></figure>
<p>/<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong> <strong>vmx_x86_ops<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><em>**</em></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>/</p>
<h3 id="vmx"><a href="#vmx" class="headerlink" title="vmx"></a>vmx</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> kvm&#123;</span><br><span class="line">	<span class="keyword">struct</span> kvm_vcpu *vcpus[KVM_MAX_VCPUS];</span><br><span class="line">	<span class="keyword">atomic_t</span> online_vcpus;</span><br><span class="line">	<span class="keyword">struct</span> list_head vm_list;</span><br><span class="line">	<span class="keyword">atomic_t</span> users_count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> kvm_vcpu &#123;</span><br><span class="line">	<span class="keyword">struct</span> kvm *kvm;</span><br><span class="line">	<span class="keyword">int</span> cpu;</span><br><span class="line">	<span class="keyword">int</span> vcpu_id;</span><br><span class="line">	<span class="keyword">int</span> mode;</span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	 * 包含退出原因等参数</span><br><span class="line">	 * for KVM_RUN, returned by mmap(vcpu_fd, offset=0)</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="keyword">struct</span> kvm_run *run;</span><br><span class="line">	<span class="keyword">struct</span> pid *pid;</span><br><span class="line">	<span class="keyword">struct</span> kvm_vcpu_stat stat;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * Track a VMCS that may be loaded on a certain CPU. If it is (cpu!=-1), also</span><br><span class="line"> * remember whether it was VMLAUNCHed, and maintain a linked list of all VMCSs</span><br><span class="line"> * loaded on this CPU (so we can clear them if the CPU goes down).</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">struct</span> loaded_vmcs&#123;</span><br><span class="line">	<span class="keyword">struct</span> vmcs *vmcs;</span><br><span class="line">	<span class="keyword">int</span> cpu;</span><br><span class="line">	<span class="keyword">int</span> launched;</span><br><span class="line">	<span class="keyword">struct</span> list_head loaded_vmcss_on_cpu_link;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> vcpu_vmx &#123;</span><br><span class="line">	<span class="keyword">struct</span> kvm_vcpu vcpu;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> vpid;</span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	 * loaded_vmcs points to the VMCS currently used in this vcpu. For a</span><br><span class="line">	 * non-nested (L1) guest, it always points to vmcs01. For a nested</span><br><span class="line">	 * guest (L2), it points to a different VMCS.</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="keyword">struct</span> loaded_vmcs    vmcs01;	<span class="comment">//</span></span><br><span class="line">	<span class="keyword">struct</span> loaded_vmcs   *loaded_vmcs;</span><br><span class="line">	<span class="keyword">bool</span>                  __launched; <span class="comment">/* temporary, used in vmx_vcpu_run */</span></span><br><span class="line">	u32 exit_reason;</span><br><span class="line">	<span class="comment">/* Support for a guest hypervisor (nested VMX) */</span></span><br><span class="line">	<span class="keyword">struct</span> nested_vmx nested;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> kvm_x86_ops vmx_x86_ops = &#123;</span><br><span class="line">	...</span><br><span class="line">	.vcpu_create = vmx_create_vcpu,		<span class="comment">//产生vmcs实例</span></span><br><span class="line">	.vcpu_load = vmx_vcpu_load,			<span class="comment">//将vmcs实例载入当前cpu中</span></span><br><span class="line">	.run = vmx_vcpu_run;				<span class="comment">//kvm_x86_ops的具体实现,static void __noclone vmx_vcpu_run(struct kvm_vcpu *vcpu)</span></span><br><span class="line">	.handle_exit = vmx_handle_exit;		<span class="comment">//static int vmx_handle_exit(struct kvm_vcpu *vcpu)</span></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * 使能vmx工作做的一些初始化</span><br><span class="line"> * 就是给vcpu_vmx结构体赋值</span><br><span class="line"> * 然后返回&amp;vmx-&gt;vcpu</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">struct</span> kvm_vcpu *<span class="title">vmx_create_vcpu</span><span class="params">(<span class="keyword">struct</span> kvm *kvm, <span class="keyword">unsigned</span> <span class="keyword">int</span> id)</span></span>;</span><br><span class="line">	|</span><br><span class="line">	|-- <span class="keyword">struct</span> vcpu_vmx *vmx = kmem_cache_zalloc(kvm_vcpu_cache, GFP_KERNEL);<span class="comment">//实例化一个vcpu_vmx对象</span></span><br><span class="line">	|</span><br><span class="line">	|-- allocate_vpid(vmx);<span class="comment">//设置vpid</span></span><br><span class="line">	|</span><br><span class="line">	|-- err = kvm_vcpu_init(&amp;vmx-&gt;vcpu, kvm, id);<span class="comment">//设置vcpu，下面还有设置vmcs，对应的cpu等等</span></span><br><span class="line">	|...</span><br><span class="line"></span><br><span class="line"><span class="comment">/*vmx_vcpu_run()中一段核心的汇编函数的主要功能就是从ROOT模式切换至NO_ROOT模式，主要进行了：</span><br><span class="line">1、Store host registers: 主要将host状态上下文存入vm对应的vmcs结构中；</span><br><span class="line">2、Load guest registers: 主要将guest状态进行加载；</span><br><span class="line">3、Enter guest mode:     通过ASM_VMX_VMLAUNCH指令进行vm的切换，进入guest os中；</span><br><span class="line">4、Save guest registers, load host registers:   当发生VM Exit时，需要保持guest状态，同时加载host。</span><br><span class="line">当第四步完成后，Guest即从NO ROOT模式退回到ROOT模式，又恢复了HOST的执行。</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __<span class="function">noclone <span class="title">vmx_vcpu_run</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu)</span></span>;<span class="comment">//vmx.c-line6962</span></span><br><span class="line">	|</span><br><span class="line">	|-- 反复执行<span class="keyword">asm</span>(...);</span><br><span class="line">	|</span><br><span class="line">	|-- vmx-&gt;exit_reason = vmcs_read32(VM_EXIT_REASON);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * 退出原因包括vmcall</span><br><span class="line"> * 相当于ioctl</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">vmx_handle_exit</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu)</span></span>;</span><br><span class="line">	|</span><br><span class="line">	|—— kvm_vmx_exit_handlers[exit_reason](vcpu);	<span class="comment">//static int (*const kvm_vmx_exit_handlers[])(struct kvm_vcpu *vcpu)</span></span><br><span class="line">	|	|</span><br><span class="line">	|	|—— <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">handle_vmcall</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu)</span></span>;		<span class="comment">//半虚拟化接口</span></span><br><span class="line">	|		|</span><br><span class="line">	|		|—— <span class="function"><span class="keyword">int</span> <span class="title">kvm_emulate_hypercall</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu)</span></span>;</span><br><span class="line">	|			|</span><br><span class="line">	|			|--</span><br></pre></td></tr></table></figure>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://dvd0423.github.io/2016/03/25/markdownFile/" data-id="cine9k3110001nmvleirpqyyi" class="article-share-link">Share</a><div class="tags"><a href="/tags/KVM-虚拟化/">KVM,虚拟化</a></div><div class="post-nav"><a href="/2016/04/24/hello-world/" class="pre">Hello World</a></div><div data-thread-key="2016/03/25/markdownFile/" data-title="KVM源码笔记" data-url="http://dvd0423.github.io/2016/03/25/markdownFile/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2016/03/25/markdownFile/" data-title="KVM源码笔记" data-url="http://dvd0423.github.io/2016/03/25/markdownFile/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://dvd0423.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/KVM-虚拟化/" style="font-size: 15px;">KVM,虚拟化</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/04/24/fuck/">fuck</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/24/hello-world/">Hello World</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/25/markdownFile/">KVM源码笔记</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> Recent Comments</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Hexo.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'dvd0423'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>